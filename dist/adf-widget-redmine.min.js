!function(e,t){"use strict";angular.module("adf.widget.redmine",["adf.provider","chart.js","ui.bootstrap.datepicker"]).constant("redmineEndpoint","http://www.redmine.org/").constant("redmineRedirectEndpoint",null).config(["dashboardProvider",function(e){var t="Redmine",n={templateUrl:"{widgetsPath}/redmine/src/main/issues/edit/edit.html",controller:"editIssuesController",controllerAs:"vm",resolve:{projects:["redmineService",function(e){return e.getProjects()}]}};e.widget("redmine-custom-queries",{title:"Redmine Custom Queries",description:"Displays Issues from a Custom Query",category:t,templateUrl:"{widgetsPath}/redmine/src/main/issues/view.html",controller:"IssueController",controllerAs:"vm",resolve:{issues:["redmineService","config",function(e,t){if(t.customQuery)return e.getIssuesByQueryId(t.customQuery.id,t.customQuery.project_id)}]},edit:n}),e.widget("redmine-my-issues",{title:"My Redmine Issues",description:"Displays all issues assigned to me",category:t,templateUrl:"{widgetsPath}/redmine/src/main/issues/view.html",controller:"IssueController",controllerAs:"vm",resolve:{issues:["redmineService",function(e){return e.getMyIssues()}]}})}]),angular.module("adf.widget.redmine").run(["$templateCache",function(e){e.put("{widgetsPath}/redmine/src/main/chart/view.html",'<div class="alert alert-info" ng-if=!vm.config.project>Please configure the widget</div><div ng-if="vm.chart && vm.config.project"><canvas id=line class="chart chart-line" chart-data=vm.chart.data chart-series=vm.chart.series chart-options=vm.chart.options></canvas></div>'),e.put("{widgetsPath}/redmine/src/main/issues/view.html",'<style type=text/css>\n  td>a{\n    font-weight: bold;\n    padding: 2px;\n    color: white;\n    border-radius: 2px 6px 6px 2px;\n    background-color: #409ae3;\n  }\n  td>a:hover{\n    color: white;\n    background-color: #4183c4;\n  }\n  th{\n    cursor: pointer;\n  }\n  .x-scrollable {\n    width: 100%;\n    max-height: 800px;\n    overflow-x: auto;\n  }\n\n\n</style><div class="alert alert-info" ng-if=!vm.issues>Please configure the widget</div><div class="alert alert-info" ng-if="vm.issues && !vm.issues[0].id">No issues found</div><div ng-if="vm.issues && vm.issues[0].id" class=x-scrollable><table class="table table-fixed"><thead><tr><th ng-if=vm.config.columns.id.show ng-click="vm.changeOrder(\'id\')">ID â†“</th><th ng-if=vm.config.columns.tracker.show ng-click="vm.changeOrder(\'tracker.name\')">Tracker</th><th ng-if=vm.config.columns.status.show ng-click="vm.changeOrder(\'status.name\')">Status</th><th ng-if=vm.config.columns.priority.show ng-click="vm.changeOrder(\'priority.name\')">Priority</th><th ng-if=vm.config.columns.subject.show ng-click="vm.changeOrder(\'subject\')">Subject</th><th ng-if=vm.config.columns.assignee.show ng-click="vm.changeOrder(\'author.name\')">Assignee</th></tr></thead><tr ng-repeat="issue in vm.issues | orderBy: vm.order : vm.reverse"><td ng-if=vm.config.columns.id.show title="\'ID\'"><a href={{vm.issueUrl}}{{issue.id}}>#{{issue.id}}</a></td><td ng-if=vm.config.columns.tracker.show title="\'Tracker\'">{{issue.tracker.name}}</td><td ng-if=vm.config.columns.status.show title="\'Status\'">{{issue.status.name}}</td><td ng-if=vm.config.columns.priority.show title="\'Priority\'">{{issue.priority.name}}</td><td ng-if=vm.config.columns.subject.show title="\'Subject\'">{{issue.subject}}</td><td ng-if=vm.config.columns.assignee.show title="\'Assignee\'">{{issue.author.name}}</td></tr></table></div>'),e.put("{widgetsPath}/redmine/src/main/chart/edit/edit.html",'<form role=form><div class=form-group><label for=project>Project</label><select name=project id=project class=form-control ng-model=vm.config.project ng-change=vm.checkUpdates() ng-required=true><option value=All>All</option><option ng-repeat="project in vm.projects | orderBy: \'name\'" value={{project}}>{{project.name}}</option></select></div><p class=input-group>Add Filter<select name=filter id=filter class=form-control ng-model=vm.filterToAdd ng-change=vm.addFilter(vm.filterToAdd)><option ng-repeat="filter in vm.filters | orderBy: \'name\'" value={{filter.id}}>{{filter.name}}</option></select></p><div ng-if=vm.config.filterWithVersion><label for=version>Fixed Version</label><p class=input-group ng-init=vm.updateVersions()><select name=version id=version class=form-control ng-model=vm.config.version ng-change=vm.updateVersionEnd()><option ng-repeat="version in vm.versions | orderBy: \'name\'" value={{version}}>{{version.name}}</option></select><span class=input-group-btn><button class="btn btn-default" ng-click="vm.config.filterWithVersion=false" type=button><i class="glyphicon glyphicon-remove"></i></button></span></p></div><div ng-if=vm.config.filterWithAssigned><label for=assgined_to_id>Assigned To</label> <span class="glyphicon glyphicon-info-sign" uib-tooltip="Get issues which are assigned to the given user ID. <me> can be used instead an ID to fetch all issues from the logged in user. Leave empty if you want to see all issues."></span><div class=input-group><input name=assigned_to_id id=assgined_to_id class=form-control ng-model=config.assigned_to_id> <span class=input-group-btn><button class="btn btn-default" ng-click="vm.config.filterWithAssigned=false" type=button><i class="glyphicon glyphicon-remove"></i></button></span></div></div><div ng-if=vm.config.filterWithTracker><label for=tacker>Tracker</label><div class=input-group ng-init=vm.updateTracker()><select name=tracker id=tracker class=form-control ng-model=vm.config.tracker><option ng-repeat="tracker in vm.trackers | orderBy: \'name\'" value={{tracker}}>{{tracker.name}}</option></select><span class=input-group-btn><button class="btn btn-default" ng-click="vm.config.filterWithTracker=false" type=button><i class="glyphicon glyphicon-remove"></i></button></span></div></div><div class=form-group><input type=checkbox name=showIdeal ng-model=config.showIdeal> Show ideal line</div><div><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup1.opened ng-model=vm.config.timespan.fromDateTime placeholder=from show-button-bar=false type=text uib-datepicker-popup={{format}} ng-required=true> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open1() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p><p class=input-group><input class=form-control datepicker-options=vm.dateOptions is-open=vm.popup2.opened ng-model=vm.config.timespan.toDateTime placeholder=to show-button-bar=false type=text uib-datepicker-popup={{format}} ng-required=true> <span class=input-group-btn><button class="btn btn-default" ng-click=vm.open2() type=button><i class="glyphicon glyphicon-calendar"></i></button></span></p></div></form>'),e.put("{widgetsPath}/redmine/src/main/issues/edit/edit.html",'<form role=form><div class=form-group><label>My Custom-Queries</label><select name=customQuery ng-options="customQuery as customQuery.name for customQuery in vm.customQueries track by customQuery.name" required class=form-control ng-model=config.customQuery><option disabled>Select your query</option></select></div><div class=form-group><input type=checkbox name=showClosed ng-model=config.showClosed> Show closed issues</div><div class=form-group><label>Columns to show</label><li class=list-group-item ng-repeat="(key, entry) in vm.possibleColumns"><input type=checkbox name={{key}} ng-model=config.columns[key].show> {{entry.name}}</li></div></form>')}]),angular.module("adf.widget.redmine").controller("editIssuesController",["projects","config","redmineService",function(e,t,n){var i=this;i.possibleColumns={id:{name:"ID",show:!0},tracker:{name:"Tracker",show:!0},status:{name:"Status",show:!0},subject:{name:"Subject",show:!0},assignee:{name:"Assignee",show:!0},priority:{name:"Priority",show:!0}},n.getCustomQueries().then(function(e){e&&e.queries?i.customQueries=e.queries:i.customQueries=null}),angular.equals({},t)&&(t.columns=i.possibleColumns,t.project="",t.assigned_to_id="me",t.showClosed=!1),i.projects=e}]),angular.module("adf.widget.redmine").controller("editChartController",["projects","config","chartDataService","redmineService",function(e,t,n,i){function s(e){"version"===e?m.config.filterWithVersion=!0:"assigned"===e?m.config.filterWithAssigned=!0:"tracker"===e&&(m.config.filterWithTracker=!0),m.filterToAdd="none"}function r(){m.config.timespan.fromDateTime&&(m.config.timespan.fromDateTime=new Date(m.config.timespan.fromDateTime),m.config.timespan.toDateTime=new Date(m.config.timespan.toDateTime))}function o(){m.inlineOptions.minDate=m.inlineOptions.minDate?null:new Date,m.dateOptions.minDate=m.inlineOptions.minDate}function a(){if(m.config.project){if("All"===m.config.project)return void(m.versions=[]);i.getVersions(angular.fromJson(m.config.project).identifier).then(function(e){m.versions=e})}}function c(){m.config.filterWithVersion&&m.updateVersions()}function u(){m.config.timespan.toDateTime=new Date(angular.fromJson(m.config.version).due_date);var e=new Date(m.config.timespan.toDateTime);m.config.timespan.fromDateTime=e.setDate(e.getDate()-14)}function l(){i.getTrackers().then(function(e){m.trackers=e})}function d(e){var t=e.date,n=e.mode;if("day"===n)for(var i=new Date(t).setHours(0,0,0,0),s=0;s<m.events.length;s++){var r=new Date(m.events[s].date).setHours(0,0,0,0);if(i===r)return m.events[s].status}return""}var m=this;m.config=t,m.projects=e,m.addFilter=s,m.converStringsToDateObjects=r,m.toggleMin=o,m.open1=function(){m.popup1.opened=!0},m.open2=function(){m.popup2.opened=!0},m.updateVersions=a,m.checkUpdates=c,m.updateVersionEnd=u,m.updateTracker=l,m.filters=[{id:"version",name:"Fixed Version"},{id:"assigned",name:"Assigned to"},{id:"tracker",name:"Tracker"}],m.config.timespan||(m.config.timespan={}),m.inlineOptions={customClass:d,minDate:new Date,showWeeks:!0},m.dateOptions||(m.dateOptions={formatYear:"yy",startingDay:1}),m.formats=["yyyy-MM-dd","yyyy/MM/dd","dd.MM.yyyy","shortDate"],m.format=m.formats[0],m.altInputFormats=["M!/d!/yyyy"],m.popup1={opened:!1},m.popup2={opened:!1},m.toggleMin(),m.converStringsToDateObjects()}]),angular.module("adf.widget.redmine").controller("IssueController",["issues","config","redmineService",function(e,t,n){var i=this;t&&(i.config=t),t.columns||(i.config={columns:{id:{name:"ID",show:!0},tracker:{name:"Tracker",show:!0},status:{name:"Status",show:!0},subject:{name:"Subject",show:!0},assignee:{name:"Assignee",show:!1},priority:{name:"Priority",show:!0}},assigned_to_id:"me"}),e&&(i.issues=e,e.issues&&(i.issues=i.issues.issues));var s=n.getRedmineRedirectEndpoint();s||(s=n.getRedmineEndpoint()),i.issueUrl=s+"issues/",i.order="id",i.changeOrder=function(e){i.order=e,i.reverse=!i.reverse}}]),angular.module("adf.widget.redmine").factory("chartDataService",["$q","redmineService",function(e,t){function n(e){return e.numberPoints=50,t.getIssuesForChart(e).then(function(t){var n=new Date(e.timespan.fromDateTime),s=new Date(e.timespan.toDateTime);return i(n,s,t,e)})}function i(e,t,n,i){for(var o=Math.abs(e.getTime()-t.getTime()),a=Math.ceil(o/864e5),c=a/i.numberPoints,u=n.length,l=u/a,d=[],m=[],g=[];e.getTime()<=t.getTime();){s(n,m,e),r(m,e);var p={x:e.toISOString(),y:m.length};if(g.push(p),i.showIdeal){var f=Math.round(100*(u-d.length*l*c))/100,h={x:e.toISOString(),y:f};d.push(h)}e.setDate(e.getDate()+c)}var v=[g];return i.showIdeal&&v.push(d),v}function s(e,t,n){for(var i=0;i<e.length;i++){var s=new Date(e[i].created_on);if(!(s.getTime()<=n.getTime()))break;t.push(e[i]),e.splice(i,1),i--}}function r(e,t){for(var n=0;n<e.length;n++)if(e[n].closed_on){var i=new Date(e[n].closed_on);i.getTime()<=t.getTime()&&(e.splice(n,1),n--)}}return{getChartData:n}}]),angular.module("adf.widget.redmine").controller("ChartController",["chartData","config",function(e,t){var n=this;n.config=t;var i={scales:{yAxes:[{id:"y-axis-1",display:!0,position:"left",scaleLabel:{display:!0,labelString:"Open Issues"}}],xAxes:[{id:"x-axis-1",type:"time",time:{displayFormats:{day:"D.MMM",week:"D.MMM",month:"MMM/YY",quarter:"[Q]Q - YYYY",year:"YYYY"}}}]},legend:{display:!0,position:"bottom"},responsive:!0};n.chart={data:e,series:[],"class":"chart-line",options:i},n.config.project&&"All"!==n.config.project?n.chart.series.push(angular.fromJson(n.config.project).name):n.chart.series.push("All Projects"),n.config.showIdeal&&n.chart.series.push("Ideal")}]),angular.module("adf.widget.redmine").factory("redmineService",["$http","redmineEndpoint","redmineRedirectEndpoint","$q",function(e,t,n,i){function s(e){return e.data}function r(n){return e.get(t+n).then(s)}function o(){return r("projects.json").then(function(e){return e.projects})}function a(e){return r("projects/"+e+"/versions.json").then(function(e){return e.versions})}function c(e){var t=f(e),n=e.limit?e.limit:Number.MAX_SAFE_INTEGER;return l(t,n)}function u(e){var t=[],n=e.limit?e.limit:Number.MAX_SAFE_INTEGER,s=m(e),r=p(e),o=g(e);return i.all([l(s,n),l(r,n),l(o,n)]).then(function(e){return angular.forEach(e,function(e){angular.forEach(e,function(e){t.push(e)})}),t})}function l(e,t){var n=[];return d(e,0).then(function(s){angular.forEach(s.issues,function(e){n.push(e)});for(var r=[],o=100;o<s.total_count&&o<t;o+=100)r.push(d(e,o));return e.length>0?i.all(r).then(function(e){return angular.forEach(e,function(e){angular.forEach(e.issues,function(e){n.push(e)})}),n}):n})}function d(e,t){return r("issues.json"+e+"&offset="+t).then(function(e){return e})}function m(e){var t=f(e);t+="&status_id=*";var n=new Date(e.timespan.toDateTime);return t+="&created_on=<="+h(n),t+="&closed_on=>="+h(n)}function g(e){var t=f(e);t+="&status_id=open";var n=new Date(e.timespan.toDateTime);return t+="&created_on=<="+h(n)}function p(e){var t=f(e);t+="&status_id=*";var n=new Date(e.timespan.fromDateTime),i=new Date(e.timespan.toDateTime);return t+="&closed_on=><"+h(n)+"|"+h(i)}function f(e){var t="?limit=100&sort=created_on";return e.project&&"All"!==e.project&&(t+="&project_id="+angular.fromJson(e.project).id),e.filterWithAssigned&&e.assigned_to_id&&(t+="&assigned_to_id="+e.assigned_to_id),e.showClosed&&(t+="&status_id=*"),e.filterWithVersion&&e.version&&(t+="&fixed_version_id="+angular.fromJson(e.version).id),e.filterWithTracker&&e.tracker&&(t+="&tracker_id="+angular.fromJson(e.tracker).id),t}function h(e){var t=e.getDate(),n=e.getMonth()+1,i=e.getFullYear();return""+i+"-"+(n<=9?"0"+n:n)+"-"+(t<=9?"0"+t:t)}function v(){return r("queries.json?limit=100")}function y(e,t){return r("issues.json?query_id="+e+"&project_id="+t).then(function(e){return e.issues})}function w(){return t}function b(){return n}function k(){return r("trackers.json").then(function(e){return e.trackers})}function D(){return r("issues.json?assigned_to_id=me").then(function(e){return e})}return{getIssues:c,getIssuesForChart:u,getProjects:o,getVersions:a,getCustomQueries:v,getIssuesByQueryId:y,getRedmineEndpoint:w,getRedmineRedirectEndpoint:b,getTrackers:k,getMyIssues:D}}])}(window);